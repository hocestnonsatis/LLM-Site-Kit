export const LLM_Meta = {
  priority: "high",
  category: "core-concept",
  token_cost: 220,
  requires: ["/docs/introduction"]
};

export default function ArchitectureDocs() {
  return `
# Architecture

This page describes how LLM-Site-Kit works under the hood: the .vllm AST pipeline, Vite plugin lifecycle, and agent middleware.

## Pipeline overview

1. **Source** — Documentation lives in \`.vllm\` files (e.g. \`src/docs/introduction.vllm\`). Each file is valid JavaScript: it exports \`LLM_Meta\` and a \`default\` function that returns a string (usually markdown).
2. **Parse** — The framework uses **acorn** (and acorn-walk) to parse the file as an AST. It extracts \`LLM_Meta\` and the default-export function body **without** executing code or using regex on the source. This keeps parsing robust for complex JS/TS structures.
3. **Build** — The Vite plugin runs at \`config\`, \`buildStart\`, and \`writeBundle\`. It walks the docs directory, parses each \`.vllm\`, and produces:
   - \`generated.js\` — A module exporting \`agentDocs\`: a map of path → \`{ content, meta, data_llm_require }\`.
   - \`llm-sitemap.json\` — Sitemap with path, token_cost, summary, requires, priority, category.
   - \`search-index.json\` (optional) — BM25 inverted index when \`enableSearchIndex: true\`.
4. **Runtime** — In development, Vite middleware serves agent JSON on the fly from parsed \`.vllm\` files. In production (e.g. SvelteKit), \`hooks.server.ts\` checks \`isAgentRequest(request)\` and, for \`/docs/*\`, returns \`agentDocs[path]\` as JSON.

## AST parsing

The .vllm parser (\`parse-vllm-ast\`) does the following:

- Parses the file with acorn.
- Finds the \`LLM_Meta\` export (ObjectExpression) and converts it to a plain object (priority, category, token_cost, requires, etc.).
- Finds the default export (e.g. \`export default function Foo() { return \`...\`; }\`) and extracts the returned string from the AST (template literal or string). No \`eval\` or \`new Function\`.

This avoids security and maintainability issues of running user .vllm code at build time.

## Middleware and agent detection

\`isAgentRequest(request)\` returns true if any of the following holds:

- \`User-Agent\` matches known LLM crawler patterns (e.g. GPTBot, Claude-Web).
- The request includes header \`X-LLM-Client\`.
- The request \`Accept\` header includes \`application/vnd.llm+json\`.

When true, the server responds with JSON instead of HTML for doc routes. Humans get the normal SvelteKit response.

## Dependency graph

Each doc can declare \`requires: ["/docs/other"]\`. The plugin validates that every required path exists in the built set and emits \`data_llm_require\` in the payload so agents know which pages to read first. The sitemap also includes \`requires\` for crawler budgeting.
`;
}
